% Calculating the NOE.
%%%%%%%%%%%%%%%%%%%%%%

\chapter{Calculating the NOE} \label{ch: NOE}
\index{NOE|textbf}


\begin{figure*}[h]
\includegraphics[width=5cm, bb=0 0 1701 1701]{graphics/analyses/noe_600x600.eps.gz}
\end{figure*}


% Introduction.
%%%%%%%%%%%%%%%

\section{Introduction}

The calculation of NOE values is a straight forward and quick procedure which involves two components -- the calculation of the value itself and the calculation of the errors.  To understand the steps involved the execution of a sample NOE calculation script will be followed in detail.



% From spectra to peak intensities.
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%

\section{From spectra to peak intensities}

For a set of recommendations for how to obtain the best quality relaxation rates, please see section~\ref{sect: spectra to intensities} on page~\pageref{sect: spectra to intensities}.



% The sample script.
%%%%%%%%%%%%%%%%%%%%

\section{The sample script}

\begin{exampleenv}
\# Script for calculating NOEs. \\
 \\
\# Create the data pipe. \\
pipe.create(`NOE', `noe') \\
 \\
\# Load the sequence from a PDB file. \\
structure.read\_pdb(name, `Ap4Aase\_new\_3.pdb') \\
structure.load\_spins(spin\_id=`@N') \\
 \\
\# Load the reference spectrum and saturated spectrum peak intensities. \\
noe.read(file=`ref.list', spectrum\_type=`ref') \\
noe.read(file=`sat.list', spectrum\_type=`sat') \\
 \\
\# Set the errors. \\
noe.error(error=3600, spectrum\_type=`ref') \\
noe.error(error=3000, spectrum\_type=`sat') \\
 \\
\# Individual residue errors. \\
noe.error(error=122000, spectrum\_type=`ref', res\_num=114) \\
noe.error(error=8500, spectrum\_type=`sat', res\_num=114) \\
 \\
\# Deselect unresolved residues. \\
deselect.read(file=`unresolved') \\
 \\
\# Calculate the NOEs. \\
calc() \\
 \\
\# Save the NOEs. \\
value.write(param=`noe', file=`noe.out', force=True) \\
 \\
\# Create grace files. \\
grace.write(y\_data\_type=`ref', file=`ref.agr', force=True) \\
grace.write(y\_data\_type=`sat', file=`sat.agr', force=True) \\
grace.write(y\_data\_type=`noe', file=`noe.agr', force=True) \\
 \\
\# View the grace files. \\
grace.view(file=`ref.agr') \\
grace.view(file=`sat.agr') \\
grace.view(file=`noe.agr') \\
 \\
\# Write the results. \\
results.write(file=`results', dir=None, force=True) \\
 \\
\# Save the program state. \\
state.save(`save', force=True)
\end{exampleenv}



% Initialisation of the data pipe.
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%

\section{Initialisation of the data pipe} \label{NOE initialisation}

The data pipe is simply created by the command

\example{pipe.create(`NOE', `noe')}

This user function will then create a NOE calculation specific data pipe labelled \texttt{`NOE'}.  The second argument sets the pipe type to that of the NOE calculation.  Setting the pipe type is important so that the program knows which user functions are compatible with the data pipe, for example the function \texttt{minimise()} is meaningless in this sample script as the NOE values are directly calculated rather than optimised.



% Loading the data.
%%%%%%%%%%%%%%%%%%%

\section{Loading the data}

The first thing which need to be completed prior to any residue specific command is to generate the sequence from a PDB file.  In this case the command

\example{structure.read\_pdb(name, `Ap4Aase\_new\_3.pdb')}
\index{PDB}

will load the PDB file `Ap4Aase\_new\_3.pdb' into relax.  Then

\example{structure.load\_spins(spin\_id=`@N')}

will generate the molecule, residue, and spin sequence for the current data pipe.  In this situation there will be a single spin system per residue generated corresponding to the backbone amide nitrogens.  Although the PDB coordinates have been loaded into the program, the structural information serves no purpose when calculating NOE values.

The next two commands

\begin{exampleenv}
noe.read(file=`ref.list', spectrum\_type=`ref') \\
noe.read(file=`sat.list', spectrum\_type=`sat')
\end{exampleenv}

load the peak heights\index{peak!height} of the reference and saturated NOE experiments (although the volume\index{peak!volume} could be used instead).  The keyword argument \texttt{format} has not been specified hence the default format of a Sparky\index{software!Sparky} peak list (saved after typing \texttt{`lt'}) is assumed.  If the program XEasy\index{software!XEasy} was used to analyse the spectra the argument \texttt{format=`xeasy'} is necessary.  The first column of the file should be the Sparky assignment string and it is assumed that the 4$^\textrm{th}$ column contains either the peak height or peak volume.  For example:

{\footnotesize \begin{verbatim}
     Assignment         w1         w2   Data Height

        LEU3N-HN    122.454      8.397       129722
        GLY4N-HN    111.999      8.719       422375
        SER5N-HN    115.085      8.176       384180
        MET6N-HN    120.934      8.812       272100
        ASP7N-HN    122.394      8.750       174970
        SER8N-HN    113.916      7.836       218762
       GLU11N-HN    122.194      8.604        30412
       GLY12N-HN    110.525      9.028        90144
\end{verbatim}}

If you have any other format you would like read by relax please send an email to the relax development mailing list\index{mailing list!relax-devel} detailing the software used, the format of the file (specifically where the residue number and peak intensity\index{peak!intensity} are located), and possibly attaching an example of the file itself.



% Setting the errors.
%%%%%%%%%%%%%%%%%%%%%

\section{Setting the errors}

In this example the errors where measured from the base plain noise.  The Sparky\index{software!Sparky} RMSD\index{RMSD} function was used to estimate the maximal noise levels across the spectrum in regions containing no peaks.  For the reference spectrum the RMSD was approximately 3600 whereas in the saturated spectrum the RMSD was 3000.  These errors are set by the commands

\begin{exampleenv}
noe.error(error=3600, spectrum\_type=`ref') \\
noe.error(error=3000, spectrum\_type=`sat')
\end{exampleenv}

For the residue G114, the noise levels are significantly increased compared to the rest of the protein as the peak is located close to the water signal.  The higher errors for this residue are specified by the commands

\begin{exampleenv}
noe.error(error=122000, spectrum\_type=`ref', res\_num=114) \\
noe.error(error=8500, spectrum\_type=`sat', res\_num=114)
\end{exampleenv}



% Unresolved residues.
%%%%%%%%%%%%%%%%%%%%%%

\section{Unresolved residues}

As the peaks of certain residues overlap to such an extent that the heights cannot be resolved, a simple text file was created called \texttt{unresolved} in which each line consists of a single residue number.  By using the command

\example{deselect.read(name, file=`unresolved')}

all residues in the file \texttt{unresolved} are excluded from the analysis.



% The NOE.
%%%%%%%%%%

\section{The NOE}

At this point the NOE can be calculated.  The user function

\example{calc()}

will calculate both the NOE and the errors.  The NOE value will be calculated using the formula
\begin{equation}
NOE = \frac{I_{sat}}{I_{ref}},
\end{equation}

\noindent where $I_{sat}$ is the intensity of the peak in the saturated spectrum and $I_{ref}$ is that of the reference spectrum.  The error is calculated by
\begin{equation}
\sigma_{NOE} = \sqrt{\frac{(\sigma_{sat} \cdot I_{ref})^2 + (\sigma_{ref} \cdot I_{sat})^2}{I_{ref}}},
\end{equation}

\noindent where $\sigma_{sat}$ and $\sigma_{ref}$ are the peak intensity errors in the saturated and reference spectra respectively.  To create a file of the NOEs the command

\example{value.write(param=`noe', file=`noe.out', force=True)}

will create a file called \texttt{noe.out} with the NOE values and errors.  The force flag will cause any file with the same name to be overwritten.  An example of the format of \texttt{noe.out} is

{\footnotesize \begin{verbatim}
Num  Name  Value                         Error
1    GLY   None                          None
2    PRO   None                          None
3    LEU   None                          None
4    GLY   0.12479588727508535           0.020551827436105764
5    SER   0.42240815792914105           0.02016346825976852
6    MET   0.45281703194372114           0.026272719841642134
7    ASP   0.60727570079478255           0.032369427242382849
8    SER   0.63871921623680161           0.024695665815261791
9    PRO   None                          None
10   PRO   None                          None
11   GLU   None                          None
12   GLY   0.92927160307645906           0.059569089743604184
13   TYR   0.88832516377296256           0.044119641308479306
14   ARG   0.84945042565860407           0.060533543601110441
\end{verbatim}}



% Viewing the results.
%%%%%%%%%%%%%%%%%%%%%%

\begin{figure}
\centerline{\includegraphics[width=0.8\textwidth, bb=0 0 792 612]{images/noe.eps.gz}}
\caption[NOE plot]{A Grace\index{software!Grace|textbf} plot of the NOE value and error against the residue number.  This is an example of the output of the user function \texttt{grace.write()}.}\label{fig: NOE plot}
\end{figure}


\section{Viewing the results}

Any two dimensional data set can be plotted in relax in conjunction with the program \href{http://plasma-gate.weizmann.ac.il/Grace/}{Grace}\index{software!Grace|textbf}.  The program is also known as Xmgrace and was previously known as ACE/gr or Xmgr.  The highly flexible relax user function \texttt{grace.write} is capable of producing 2D plots of any x-y data sets.  The three commands

\begin{exampleenv}
grace.write(y\_data\_type=`ref', file=`ref.agr', force=True) \\
grace.write(y\_data\_type=`sat', file=`sat.agr', force=True) \\
grace.write(y\_data\_type=`noe', file=`noe.agr', force=True)
\end{exampleenv}

create three separate plots of the peak intensity of the reference and saturated spectra as well as the NOE.  The x-axis in all three defaults to the residue number.  As the x and y-axes can be any parameter the command

\example{grace.write(x\_data\_type=`ref', y\_data\_type=`sat', file=`ref\_vs\_sat.agr', force=True)}

would create a plot of the reference verses the saturated intensity with one point per residue.  Returning to the sample script three Grace data files are created \texttt{ref.agr}, \texttt{sat.agr}, and \texttt{noe.agr} and placed in the default directory \texttt{./grace}.  These can be visualised by opening the file within Grace.  However relax will do that for you with the commands

\begin{exampleenv}
grace.view(file=`ref.agr') \\
grace.view(file=`sat.agr') \\
grace.view(file=`noe.agr')
\end{exampleenv}

An example of the output after modifying the axes is shown in figure~\ref{fig: NOE plot}.


% GUI.
%%%%%%

\section{The GUI auto-analysis}

The relax graphical user interface provides access to an automated steady-state NOE analysis (Figure~\ref{fig: screenshot: NOE analysis}).  This can be selected through the analysis selection wizard, see Figure~\ref{fig: screenshot: analysis wizard} on page~\pageref{fig: screenshot: analysis wizard}.  This auto-analysis operates in the same way as the sample script described in this chapter.  The 2D Grace visualisation will also be created as part of the analysis and presented in the results viewer window (Figure~\ref{fig: screenshot: results viewer} on page~\pageref{fig: screenshot: results viewer}).

% NOE analysis screenshot
\begin{figure}
\centerline{\includegraphics[width=\textwidth, bb=14 14 1065 768]{graphics/screenshots/analysis_noe.eps.gz}}
\caption[GUI screenshot -- NOE analysis]{Screenshot of the relax GUI interface -- the steady-state NOE analysis.}\label{fig: screenshot: NOE analysis}
\end{figure}
